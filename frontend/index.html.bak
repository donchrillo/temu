<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEMU Worker Dashboard</title>
    <link rel="stylesheet" href="styles.css">
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: #1e293b;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #3b82f6;
        }
        
        h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .status-bar {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .status-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .status-label {
            font-size: 12px;
            color: #94a3b8;
            text-transform: uppercase;
        }
        
        .status-value {
            font-size: 16px;
            font-weight: 600;
        }
        
        /* ===== TABS ===== */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #334155;
            background: #1e293b;
            padding: 15px 20px;
            border-radius: 8px;
        }
        
        .tab-btn {
            padding: 8px 16px;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .tab-btn:hover {
            color: #e2e8f0;
        }
        
        .tab-btn.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ===== JOBS GRID ===== */
        .jobs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .job-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .job-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.1);
        }
        
        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }
        
        .job-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .job-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-running {
            background: #fbbf24;
            color: #000;
        }
        
        .status-success {
            background: #10b981;
            color: #fff;
        }
        
        .status-failed {
            background: #ef4444;
            color: #fff;
        }
        
        .status-idle {
            background: #6b7280;
            color: #fff;
        }
        
        .job-info {
            display: grid;
            gap: 10px;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            background: #0f172a;
            border-radius: 4px;
        }
        
        .info-label {
            color: #94a3b8;
        }
        
        .info-value {
            font-weight: 600;
            color: #e2e8f0;
        }
        
        .job-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        button {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .btn-primary {
            background: #3b82f6;
            color: #fff;
        }
        
        .btn-primary:hover {
            background: #2563eb;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: #fff;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-success {
            background: #10b981;
            color: #fff;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-danger {
            background: #ef4444;
            color: #fff;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        /* ===== LOG VIEWER ===== */
        .logs-section {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
        }
        
        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .logs-title {
            font-size: 16px;
            font-weight: 600;
        }
        
        .log-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .log-filter {
            background: #0f172a;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .filter-group label {
            font-size: 12px;
            color: #94a3b8;
            text-transform: uppercase;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 4px;
            color: #e2e8f0;
            font-size: 12px;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .logs-container {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 4px;
            padding: 15px;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
        }
        
        .log-line {
            color: #94a3b8;
            margin-bottom: 5px;
            padding: 4px 8px;
            border-left: 3px solid transparent;
        }
        
        .log-success {
            color: #10b981;
            border-left-color: #10b981;
        }
        
        .log-error {
            color: #ef4444;
            border-left-color: #ef4444;
        }
        
        .log-warning {
            color: #fbbf24;
            border-left-color: #fbbf24;
        }
        
        .log-info {
            color: #3b82f6;
            border-left-color: #3b82f6;
        }
        
        /* ===== STATISTIKEN ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #3b82f6;
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 12px;
            color: #94a3b8;
            text-transform: uppercase;
        }
        
        .stat-card.success .stat-value {
            color: #10b981;
        }
        
        .stat-card.error .stat-value {
            color: #ef4444;
        }
        
        .stat-card.warning .stat-value {
            color: #fbbf24;
        }
        
        /* ===== MODALS ===== */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: #1e293b;
            padding: 30px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
        }
        
        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        
        .modal-body {
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ TEMU Worker Dashboard</h1>
            <div id="debug-info" style="font-size: 11px; color: #fbbf24; margin-bottom: 10px;">Initialisiere...</div>
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-label">Status</div>
                    <div class="status-value" id="status">Offline</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Aktive Jobs</div>
                    <div class="status-value" id="active-jobs">0</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Erfolgsrate</div>
                    <div class="status-value" id="success-rate">‚Äî</div>
                </div>
            </div>
        </header>
        
        <!-- TABS -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('jobs')">üìä Jobs</button>
            <button class="tab-btn" onclick="switchTab('logs')">üìã Logs</button>
            <button class="tab-btn" onclick="switchTab('errors')">üö® Errors</button>
            <button class="tab-btn" onclick="switchTab('stats')">üìà Statistiken</button>
        </div>
        
        <!-- TAB 1: JOBS -->
        <div id="jobs-tab" class="tab-content active">
            <div class="jobs-grid" id="jobs-grid">
                <!-- Jobs werden hier eingef√ºgt -->
            </div>
        </div>
        
        <!-- TAB 2: LOGS mit Filtern -->
        <div id="logs-tab" class="tab-content">
            <div class="logs-section">
                <div class="logs-header">
                    <div class="logs-title">üìã Strukturierte Log-Suche</div>
                    <div class="log-controls">
                        <button class="btn-secondary" onclick="exportLogs('json')">üì• JSON</button>
                        <button class="btn-secondary" onclick="exportLogs('csv')">üì• CSV</button>
                        <button class="btn-secondary" onclick="clearLogFilter()">üîÑ Reset</button>
                    </div>
                </div>
                
                <div class="log-filter">
                    <div class="filter-group">
                        <label>Job</label>
                        <select id="filter-job" onchange="applyLogFilters()">
                            <option value="">‚Äî Alle Jobs ‚Äî</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Level</label>
                        <select id="filter-level" onchange="applyLogFilters()">
                            <option value="">‚Äî Alle Level ‚Äî</option>
                            <option value="DEBUG">DEBUG</option>
                            <option value="INFO">INFO</option>
                            <option value="WARNING">WARNING</option>
                            <option value="ERROR">ERROR</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Suche</label>
                        <input type="text" id="filter-search" placeholder="Suchtext..." onkeyup="applyLogFilters()">
                    </div>
                    <div class="filter-group">
                        <label>Limit</label>
                        <select id="filter-limit" onchange="applyLogFilters()">
                            <option value="50">50 Logs</option>
                            <option value="100" selected>100 Logs</option>
                            <option value="500">500 Logs</option>
                            <option value="1000">1000 Logs</option>
                        </select>
                    </div>
                </div>
                
                <div class="logs-container" id="logs-container">
                    <div class="log-line">Warte auf Logs...</div>
                </div>
            </div>
        </div>
        
        <!-- TAB 3: ERROR LOGS -->
        <div id="errors-tab" class="tab-content">
            <div class="logs-section">
                <div class="logs-header">
                    <div class="logs-title">üö® Exception & Error Logs</div>
                    <div class="log-controls">
                        <button class="btn-secondary" onclick="clearErrorFilter()">üîÑ Reset</button>
                    </div>
                </div>
                
                <div class="log-filter">
                    <div class="filter-group">
                        <label>Level</label>
                        <select id="filter-error-level" onchange="loadErrorLogs()">
                            <option value="">‚Äî Alle Level ‚Äî</option>
                            <option value="ERROR">ERROR</option>
                            <option value="CRITICAL">CRITICAL</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Tage</label>
                        <select id="filter-error-days" onchange="loadErrorLogs()">
                            <option value="1">1 Tag</option>
                            <option value="7" selected>7 Tage</option>
                            <option value="30">30 Tage</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Limit</label>
                        <select id="filter-error-limit" onchange="loadErrorLogs()">
                            <option value="50">50 Logs</option>
                            <option value="100" selected>100 Logs</option>
                            <option value="500">500 Logs</option>
                        </select>
                    </div>
                </div>
                
                <div class="logs-container" id="errors-container">
                    <div class="log-line">Warte auf Error-Logs...</div>
                </div>
            </div>
        </div>
        
        <!-- TAB 4: STATISTIKEN -->
        <div id="stats-tab" class="tab-content">
            <div class="logs-section">
                <div class="logs-header">
                    <div class="logs-title">üìà Job-Statistiken (7 Tage)</div>
                </div>
                
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Insgesamt L√§ufe</div>
                        <div class="stat-value" id="stat-total">0</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-label">Erfolgreich</div>
                        <div class="stat-value" id="stat-success">0</div>
                    </div>
                    <div class="stat-card error">
                        <div class="stat-label">Fehler</div>
                        <div class="stat-value" id="stat-failed">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Erfolgsrate</div>
                        <div class="stat-value" id="stat-success-rate">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">√ò Dauer</div>
                        <div class="stat-value" id="stat-avg-duration">0s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Max Dauer</div>
                        <div class="stat-value" id="stat-max-duration">0s</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL f√ºr Logs Detailansicht -->
    <div id="log-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Vollst√§ndige Logs</div>
            <div class="modal-body" id="modal-body">
                <!-- Logs werden hier angezeigt -->
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal()">Schlie√üen</button>
            </div>
        </div>
    </div>
    
    <script>
        // ===== KONFIGURATION =====
        const HOST = window.location.hostname === 'localhost' 
            ? 'localhost' 
            : window.location.hostname;
        const PORT = window.location.port || '8000';
        
        const API_URL = `http://${HOST}:${PORT}/api`;
        const WS_URL = `ws://${HOST}:${PORT}/ws/logs`;
        
        console.log("üîó API URL:", API_URL);
        console.log("üîó WS URL:", WS_URL);
        
        let ws = null;
        let jobs = [];
        let allLogs = [];
        let selectedJobId = null;
        let wsReconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        
        // ===== TAB MANAGEMENT =====
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            event.target.classList.add('active');
            
            // Load data f√ºr Tab
            if (tabName === 'logs') {
                loadAllLogs();
            } else if (tabName === 'stats') {
                loadStatistics();
            } else if (tabName === 'errors') {
                loadErrorLogs();
            }
        }
        
        // ===== DEBUG INFO =====
        function showDebugInfo(message) {
            const debugEl = document.getElementById("debug-info");
            if (debugEl) {
                debugEl.textContent = message;
            }
            console.log(message);
        }
        
        // ===== API HEALTH CHECK =====
        async function testApiHealth() {
            try {
                showDebugInfo("üîç Teste API-Verbindung...");
                const response = await fetch(`${API_URL}/health`);
                if (response.ok) {
                    showDebugInfo("‚úì API erreichbar!");
                    return true;
                } else {
                    showDebugInfo(`‚úó API Status ${response.status}`);
                    return false;
                }
            } catch (e) {
                showDebugInfo(`‚úó API nicht erreichbar: ${e.message}`);
                return false;
            }
        }
        
        // ===== WEBSOCKET =====
        function connectWebSocket() {
            console.log("üì° Verbinde WebSocket...");
            ws = new WebSocket(WS_URL);
            
            ws.onopen = () => {
                console.log("‚úì WebSocket verbunden");
                showDebugInfo("‚úì WebSocket verbunden!");
                document.getElementById("status").textContent = "Online";
                wsReconnectAttempts = 0;
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === "jobs_update") {
                        jobs = data.data;
                        console.log(`üìã ${jobs.length} Jobs geladen`);
                        renderJobs();
                        updateJobFilter();
                    }
                } catch (e) {
                    console.error("‚ùå JSON Parse Error:", e);
                }
            };
            
            ws.onerror = () => {
                console.error("‚ùå WebSocket Fehler");
                document.getElementById("status").textContent = "Fehler";
            };
            
            ws.onclose = () => {
                console.warn("‚ö† WebSocket geschlossen");
                document.getElementById("status").textContent = "Offline";
                
                wsReconnectAttempts++;
                if (wsReconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    const delay = Math.min(3000 * wsReconnectAttempts, 10000);
                    setTimeout(connectWebSocket, delay);
                }
            };
        }
        
        // ===== LOGS LADEN =====
        async function loadAllLogs() {
            try {
                const jobId = document.getElementById('filter-job').value || '';
                const level = document.getElementById('filter-level').value || '';
                const limit = document.getElementById('filter-limit').value || 100;
                
                let url = `${API_URL}/logs?limit=${limit}`;
                if (jobId) url += `&job_id=${jobId}`;
                if (level) url += `&level=${level}`;
                
                console.log("üì• Lade Logs mit URL:", url);
                
                const response = await fetch(url);
                if (response.ok) {
                    allLogs = await response.json();
                    console.log(`üìã ${allLogs.length} Logs geladen`);
                    renderLogs(allLogs);
                } else {
                    console.error("‚ùå API Error:", response.status);
                }
            } catch (e) {
                console.error("‚ùå Logs laden fehlgeschlagen:", e);
            }
        }
        
        // ===== ERROR LOGS LADEN =====
        async function loadErrorLogs() {
            try {
                const level = document.getElementById('filter-error-level').value || '';
                const days = document.getElementById('filter-error-days').value || '7';
                const limit = document.getElementById('filter-error-limit').value || 100;
                
                let url = `${API_URL}/logs/errors?limit=${limit}&days=${days}`;
                if (level) url += `&level=${level}`;
                
                console.log("üì• Lade Error-Logs mit URL:", url);
                
                const response = await fetch(url);
                if (response.ok) {
                    const data = await response.json();
                    console.log(`üìã ${data.data.length} Error-Logs geladen`);
                    renderErrorLogs(data.data);
                } else {
                    console.error("‚ùå API Error:", response.status);
                }
            } catch (e) {
                console.error("‚ùå Error-Logs laden fehlgeschlagen:", e);
            }
        }
        
        // ===== LOG FILTER & SUCHE =====
        function updateJobFilter() {
            const select = document.getElementById('filter-job');
            const currentValue = select.value;
            
            // Sammle alle Job-IDs
            const jobIds = [...new Set(jobs.map(j => j.job_id))];
            
            // Behalte "Alle Jobs" Option
            select.innerHTML = '<option value="">‚Äî Alle Jobs ‚Äî</option>';
            jobIds.forEach(id => {
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = jobs.find(j => j.job_id === id)?.config.description || id;
                select.appendChild(opt);
            });
            
            select.value = currentValue;
        }
        
        // ‚úÖ KORRIGIERT: Rufe API mit Filtern auf (nicht nur client-side)
        function applyLogFilters() {
            loadAllLogs();  // ‚Üê API mit neuen Filtern aufrufen!
        }
        
        function clearLogFilter() {
            document.getElementById('filter-job').value = '';
            document.getElementById('filter-level').value = '';
            document.getElementById('filter-search').value = '';
            loadAllLogs();
        }
        
        // ===== ERROR LOG FILTER & SUCHE =====
        function clearErrorFilter() {
            document.getElementById('filter-error-level').value = '';
            document.getElementById('filter-error-days').value = '7';
            document.getElementById('filter-error-limit').value = '100';
            loadErrorLogs();
        }
        
        // ===== LOG RENDERING =====
        function renderLogs(logs) {
            const container = document.getElementById('logs-container');
            
            // ‚úÖ KORRIGIERT: Client-side Suche anwenden!
            const searchText = document.getElementById('filter-search').value.toLowerCase();
            
            let filteredLogs = logs;
            if (searchText) {
                filteredLogs = logs.filter(log => 
                    log.message.toLowerCase().includes(searchText) ||
                    (log.job_id && log.job_id.toLowerCase().includes(searchText))
                );
            }
            
            if (!filteredLogs || filteredLogs.length === 0) {
                container.innerHTML = '<div class="log-line">Keine Logs vorhanden</div>';
                return;
            }
            
            // ‚úÖ WICHTIG: Reverse f√ºr DESC (neueste zuerst!)
            container.innerHTML = filteredLogs.reverse()
                .map(log => {
                    let className = 'log-line';
                    if (log.level === 'ERROR') {
                        className = 'log-line log-error';
                    } else if (log.level === 'WARNING') {
                        className = 'log-line log-warning';
                    } else if (log.level === 'DEBUG') {
                        className = 'log-line';
                    } else {
                        className = 'log-line log-info';
                    }
                    
                    const timestamp = log.timestamp ? new Date(log.timestamp).toLocaleTimeString('de-DE') : '';
                    
                    return `
                        <div class="${className}">
                            <strong>[${timestamp}]</strong> 
                            <span style="color: #94a3b8;">[${log.level}]</span>
                            ${escapeHtml(log.message)}
                        </div>
                    `;
                })
                .join('');
            
            container.scrollTop = 0;  // ‚úÖ Scroll nach oben (zu neuesten Logs)
        }
        
        // ===== ERROR LOG RENDERING =====
        function renderErrorLogs(errors) {
            const container = document.getElementById('errors-container');
            
            if (!errors || errors.length === 0) {
                container.innerHTML = '<div class="log-line">Keine Error-Logs vorhanden</div>';
                return;
            }
            
            // ‚úÖ WICHTIG: Reverse f√ºr DESC (neueste zuerst!)
            container.innerHTML = errors.reverse()
                .map(err => {
                    const timestamp = err.timestamp ? new Date(err.timestamp).toLocaleTimeString('de-DE') : '';
                    const exceptionType = err.exception_type ? `[${err.exception_type}]` : '';
                    
                    return `
                        <div class="log-line log-error">
                            <strong>[${timestamp}]</strong> 
                            <span style="color: #ef4444;">${exceptionType}</span><br>
                            <strong>${err.module}::${err.function}</strong> (Zeile ${err.line_number})<br>
                            ${escapeHtml(err.message)}<br>
                            <span style="font-size: 11px; color: #94a3b8; margin-top: 5px; display: block;">
                                üìù ${err.traceback_text ? err.traceback_text.substring(0, 200) + '...' : 'Kein Traceback'}
                            </span>
                        </div>
                    `;
                })
                .join('');
            
            container.scrollTop = 0;  // ‚úÖ Scroll nach oben (zu neuesten Logs)
        }
        
        // ===== STATISTIKEN =====
        async function loadStatistics() {
            try {
                const jobId = document.getElementById('filter-job').value || '';
                let url = `${API_URL}/logs/stats`;
                if (jobId) url += `?job_id=${jobId}`;
                
                const response = await fetch(url);
                if (response.ok) {
                    const stats = await response.json();
                    renderStatistics(stats);
                }
            } catch (e) {
                console.error("‚ùå Stats laden fehlgeschlagen:", e);
            }
        }
        
        function renderStatistics(stats) {
            document.getElementById('stat-total').textContent = stats.total_runs || 0;
            document.getElementById('stat-success').textContent = stats.successful_runs || 0;
            document.getElementById('stat-failed').textContent = stats.failed_runs || 0;
            document.getElementById('stat-success-rate').textContent = (stats.success_rate || 0).toFixed(1) + '%';
            document.getElementById('stat-avg-duration').textContent = (stats.avg_duration || 0).toFixed(2) + 's';
            document.getElementById('stat-max-duration').textContent = (stats.max_duration || 0).toFixed(2) + 's';
            
            // Update Erfolgsrate im Header
            document.getElementById('success-rate').textContent = (stats.success_rate || 0).toFixed(0) + '%';
        }
        
        // ===== EXPORT =====
        async function exportLogs(format) {
            try {
                const jobId = document.getElementById('filter-job').value || '';
                let url = `${API_URL}/logs/export?format=${format}`;
                if (jobId) url += `&job_id=${jobId}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                const filename = `temu_logs_${new Date().toISOString().split('T')[0]}.${format}`;
                const blob = new Blob([data.data], { type: 'text/plain' });
                const url_link = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url_link;
                a.download = filename;
                a.click();
                
                alert(`‚úì Logs exportiert: ${filename}`);
            } catch (e) {
                console.error("‚ùå Export fehlgeschlagen:", e);
                alert("‚úó Fehler beim Export");
            }
        }
        
        // ===== JOB RENDERING =====
        function renderJobs() {
            const grid = document.getElementById('jobs-grid');
            grid.innerHTML = "";
            
            jobs.forEach(job => {
                const card = document.createElement("div");
                card.className = "job-card";
                
                const lastRun = job.status.last_run 
                    ? new Date(job.status.last_run).toLocaleString("de-DE")
                    : "Noch nie";
                
                const nextRun = job.status.next_run 
                    ? new Date(job.status.next_run).toLocaleString("de-DE")
                    : "‚Äî";
                
                const statusClass = `status-${job.status.status.toLowerCase()}`;
                
                const lastDuration = job.status.last_duration 
                    ? `<div class="info-row">
                        <span class="info-label">Dauer:</span>
                        <span class="info-value">${job.status.last_duration.toFixed(2)}s</span>
                    </div>`
                    : "";
                
                const lastError = job.status.last_error 
                    ? `<div class="info-row" style="background: #7f1d1d;">
                        <span class="info-label">Fehler:</span>
                        <span class="info-value">${escapeHtml(job.status.last_error.substring(0, 50))}</span>
                    </div>`
                    : "";
                
                card.innerHTML = `
                    <div class="job-header">
                        <div>
                            <div class="job-title">${job.config.description}</div>
                            <div style="font-size: 12px; color: #94a3b8; margin-top: 5px;">${job.config.job_type}</div>
                        </div>
                        <div class="job-status ${statusClass}">${job.status.status}</div>
                    </div>
                    
                    <div class="job-info">
                        <div class="info-row">
                            <span class="info-label">Intervall:</span>
                            <span class="info-value">${job.config.schedule.interval_minutes} Min</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Letzte Ausf√ºhrung:</span>
                            <span class="info-value">${lastRun}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">N√§chste Ausf√ºhrung:</span>
                            <span class="info-value">${nextRun}</span>
                        </div>
                        ${lastDuration}
                        ${lastError}
                    </div>
                    
                    <div class="job-controls">
                        <button class="btn-primary" onclick="triggerJob('${job.job_id}')">Ausf√ºhren</button>
                        <button class="btn-secondary" onclick="switchToJobLogs('${job.job_id}')">üìã Logs</button>
                        <button class="btn-secondary" onclick="openIntervalDialog('${job.job_id}', ${job.config.schedule.interval_minutes})">‚è±Ô∏è</button>
                        <button class="btn-${job.config.schedule.enabled ? 'success' : 'danger'}" onclick="toggleJob('${job.job_id}', ${!job.config.schedule.enabled})">${job.config.schedule.enabled ? '‚úì' : '‚úó'}</button>
                    </div>
                `;
                
                grid.appendChild(card);
            });
            
            document.getElementById("active-jobs").textContent = jobs.length;
        }
        
        // ===== JOB CONTROL FUNKTIONEN =====
        async function triggerJob(jobId) {
            // Dialog mit Parametern
            const params = await showJobParameterDialog();
            
            if (params === null) return; // User canceled
            
            try {
                const url = `${API_URL}/jobs/${jobId}/run-now?` +
                    `parent_order_status=${params.status}&` +
                    `days_back=${params.days}&` +
                    `verbose=${params.verbose}&` +
                    `log_to_db=${params.log_to_db}`;
                
                const response = await fetch(url, { method: "POST" });
                const data = await response.json();
                
                alert(`‚úì Job gestartet mit Parametern:\n` +
                      `Status: ${params.status}\n` +
                      `Tage: ${params.days}\n` +
                      `Verbose: ${params.verbose ? 'Ja' : 'Nein'}\n` +
                      `Log-to-DB: ${params.log_to_db ? 'Ja' : 'Nein'}`);
            } catch (e) {
                console.error("‚úó Fehler:", e);
                alert("‚úó Fehler beim Starten");
            }
        }
        
        // ===== NEU: Parameter Dialog =====
        async function showJobParameterDialog() {
            return new Promise((resolve) => {
                const html = `
                    <div style="display: grid; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px;">üìä Status:</label>
                            <select id="dialog-status" style="width: 100%; padding: 8px;">
                                <option value="2">2 - UN_SHIPPING (nicht versendet)</option>
                                <option value="3">3 - CANCELLED (storniert)</option>
                                <option value="4">4 - SHIPPED (versendet)</option>
                                <option value="5">5 - RECEIPTED (Order received)</option>
                            </select>
                        </div>
                        
                        <div>
                            <label style="display: block; margin-bottom: 5px;">üìÖ Tage zur√ºck:</label>
                            <input type="number" id="dialog-days" value="7" min="1" max="365" 
                                   style="width: 100%; padding: 8px;">
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="dialog-verbose">
                                üîç Verbose Mode
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="dialog-log-to-db" checked>
                                üíæ Log to Database
                            </label>
                        </div>
                    </div>
                `;
                
                const modal = document.createElement('div');
                modal.className = 'modal active';
                modal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">‚öôÔ∏è Job Parameter</div>
                        <div class="modal-body">${html}</div>
                        <div class="modal-footer">
                            <button class="btn-secondary" onclick="this.closest('.modal').remove(); 
                                window.__jobParamResolve(null)">Abbrechen</button>
                            <button class="btn-primary" onclick="
                                const params = {
                                    status: parseInt(document.getElementById('dialog-status').value),
                                    days: parseInt(document.getElementById('dialog-days').value),
                                    verbose: document.getElementById('dialog-verbose').checked,
                                    log_to_db: document.getElementById('dialog-log-to-db').checked
                                };
                                this.closest('.modal').remove();
                                window.__jobParamResolve(params);
                            ">Starten</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                window.__jobParamResolve = resolve;
            });
        }
        
        // ===== UTILITY FUNKTIONEN =====
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        function closeModal() {
            document.getElementById('log-modal').classList.remove('active');
        }
        
        // ===== APP INIT =====
        async function init() {
            const apiOk = await testApiHealth();
            if (apiOk) {
                connectWebSocket();
            } else {
                showDebugInfo("‚ö† API nicht verf√ºgbar, versuche trotzdem WebSocket...");
                connectWebSocket();
            }
        }
        
    <script src="app.js"></script>
</body>
</html>
